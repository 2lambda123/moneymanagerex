IF(NOT InMMEX)
    MESSAGE(FATAL_ERROR "Use the top-level CMake script!")
ENDIF(NOT InMMEX)

FIND_PACKAGE(Gettext REQUIRED)

IF(NOT GETTEXT_VERSION_STRING)
    EXECUTE_PROCESS(COMMAND ${GETTEXT_MSGMERGE_EXECUTABLE} --version
        OUTPUT_VARIABLE m_version
        OUTPUT_STRIP_TRAILING_WHITESPACE ERROR_QUIET)
    GET_FILENAME_COMPONENT(m_name ${GETTEXT_MSGMERGE_EXECUTABLE} NAME)
    GET_FILENAME_COMPONENT(m_namewe ${GETTEXT_MSGMERGE_EXECUTABLE} NAME_WE)
    IF(m_version MATCHES "^(${m_name}|${m_namewe}) \\([^\\)]*\\) ([0-9\\.]+[^ \n]*)")
        SET(GETTEXT_VERSION_STRING "${CMAKE_MATCH_2}")
    ENDIF()
    UNSET(m_version)
    UNSET(m_name)
    UNSET(m_namewe)
ENDIF()
SET(GETTEXT_VERSION_STRING "${GETTEXT_VERSION_STRING}"
    CACHE INTERNAL "gettext version detected")
    
FILE(GLOB POFiles RELATIVE "${CMAKE_CURRENT_BINARY_DIR}" *.po)
FOREACH(POFile ${POFiles})
    GET_FILENAME_COMPONENT(CurrentFile "${POFile}" NAME_WE)
    ADD_CUSTOM_COMMAND(OUTPUT ${CurrentFile}.mo
        COMMAND ${GETTEXT_MSGFMT_EXECUTABLE} -o ${CurrentFile}.mo "${POFile}"
		COMMENT "Generating ${CurrentFile} translation"
        MAIN_DEPENDENCY "${POFile}")
	LIST(APPEND MOFiles "${CMAKE_CURRENT_BINARY_DIR}/${CurrentFile}.mo")
ENDFOREACH()

ADD_CUSTOM_TARGET(Translations ALL DEPENDS ${MOFiles} COMMENT "Generated translations")
INSTALL(FILES ${MOFiles} DESTINATION "${MMEX_LOCALE_DIR}")
